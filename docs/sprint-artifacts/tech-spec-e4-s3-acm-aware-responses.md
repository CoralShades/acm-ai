# Tech-Spec: E4-S3 ACM-Aware Chat Responses

**Created:** 2025-12-07
**Status:** Ready for Development
**Epic:** E4 - Chat with ACM Context
**Story:** S3 - Generate ACM-Aware Chat Responses

---

## Overview

### Problem Statement

When ACM data is in context, the AI needs to understand ACM terminology and cite specific records using `[acm:...]` format. Currently, the system prompt doesn't include ACM-specific guidance.

### Solution

Update the system prompt in the chat handler to:
- Explain ACM domain concepts
- Instruct use of `[acm:record_id:field]` citation format
- Provide examples of how to answer ACM questions

### Scope

**In Scope:**
- Update system prompt with ACM guidance
- Citation format instructions
- Domain terminology explanations

**Out of Scope:**
- Fine-tuning models
- Complex multi-turn reasoning

---

## Implementation Plan

### Tasks

- [ ] **Task 1: Analyze existing system prompt**
  - Read chat handler code
  - Understand prompt structure

- [ ] **Task 2: Create ACM prompt section**
  - Explain ACM/asbestos concepts
  - Define risk levels (Low/Medium/High)
  - Explain friable vs non-friable

- [ ] **Task 3: Add citation format instructions**
  - Format: `[acm:record_id:field]`
  - When to use citations
  - Examples

- [ ] **Task 4: Test with sample questions**
  - "What's the risk level in Building A?"
  - "Are there friable materials?"
  - "Summarize high-risk items"

### Acceptance Criteria

- [ ] **AC1**: AI responses include `[acm:...]` citations
- [ ] **AC2**: Citations are clickable in chat
- [ ] **AC3**: AI answers domain questions accurately
- [ ] **AC4**: System prompt includes ACM guidance

---

## Code Specification

### ACM System Prompt Addition

```python
ACM_SYSTEM_PROMPT = """
## ACM (Asbestos Containing Material) Context

When ACM Register data is included in context, you are helping analyze asbestos survey data. Key concepts:

**Risk Levels:**
- High: Friable materials in poor condition, immediate action needed
- Medium: Non-friable materials or good condition friable, monitor and plan
- Low: Stable materials, routine monitoring only

**Material Types:**
- Friable: Can crumble by hand, higher risk of fiber release
- Non-Friable: Bonded materials, lower risk when undisturbed

**Citation Format:**
When referencing specific ACM data, use: [acm:record_id:field_name]
Example: "The floor tiles in Room B00A-R001 are [acm:acm_record:abc123:result]"

**Response Guidelines:**
1. Cite specific records when stating facts about materials
2. Summarize risk distribution when asked about safety
3. Group findings by building/room when relevant
4. Explain technical terms if user seems unfamiliar
"""
```

### Integration Point

```python
# In chat context builder
if include_acm_context and acm_records_exist:
    system_prompt += ACM_SYSTEM_PROMPT
```

---

## Dependencies

| Dependency | Type | Notes |
|------------|------|-------|
| E4-S1 (ACM in Context) | Story | ACM data available |
| E3-S3 (Citation Parser) | Story | Parse citations |

---

*Tech-Spec generated by create-tech-spec workflow*
