# Tech-Spec: E4-S1 ACM Records in Chat Context

**Created:** 2025-12-07
**Status:** Ready for Development
**Epic:** E4 - Chat with ACM Context
**Story:** S1 - Add ACM Records to Chat Context

---

## Overview

### Problem Statement

The chat system builds context from source content and notes, but doesn't include structured ACM data. Users need to ask questions about ACM records ("What's the risk level in Building A?") and get accurate answers.

### Solution

Modify the chat context builder in `api/routers/source_chat.py` to:
- Include ACM records when toggled on
- Format as readable markdown table
- Respect token limits
- Clearly label as "ACM Register Data"

### Scope

**In Scope:**
- Add ACM data to chat context
- Format as markdown table
- Token limit handling
- Label context section

**Out of Scope:**
- UI toggle (E4-S2)
- Prompt engineering (E4-S3)

---

## Implementation Plan

### Tasks

- [ ] **Task 1: Analyze existing context builder**
  - Read `api/routers/source_chat.py`
  - Understand context format

- [ ] **Task 2: Create ACM context formatter**
  - Function to format records as markdown table
  - Include key fields only
  - Add risk status highlighting

- [ ] **Task 3: Integrate into context builder**
  - Check for ACM toggle flag
  - Fetch records for source
  - Append to context

- [ ] **Task 4: Handle token limits**
  - Truncate if too many records
  - Show summary if truncated

### Acceptance Criteria

- [ ] **AC1**: ACM records included when toggled on
- [ ] **AC2**: Formatted as readable table
- [ ] **AC3**: Token limit respected
- [ ] **AC4**: Labeled as "ACM Register Data"

---

## Code Specification

### File: `api/routers/source_chat.py` (modifications)

```python
from open_notebook.domain.acm import ACMRecord

async def format_acm_context(source_id: str, max_records: int = 50) -> str:
    """Format ACM records as markdown table for chat context."""
    records = await ACMRecord.get_by_source(source_id)

    if not records:
        return ""

    # Limit records
    truncated = len(records) > max_records
    records = records[:max_records]

    # Build markdown table
    lines = [
        "## ACM Register Data",
        "",
        "| Building | Room | Product | Material | Risk | Result |",
        "|----------|------|---------|----------|------|--------|",
    ]

    for r in records:
        lines.append(
            f"| {r.building_name or r.building_id} | "
            f"{r.room_name or '-'} | "
            f"{r.product} | "
            f"{r.material_description[:30]}... | "
            f"{r.risk_status or '-'} | "
            f"{r.result} |"
        )

    if truncated:
        lines.append("")
        lines.append(f"*({len(records)} of {len(records)} records shown)*")

    return "\n".join(lines)


# In chat endpoint, add:
if include_acm_context:
    acm_context = await format_acm_context(source_id)
    if acm_context:
        context += "\n\n" + acm_context
```

---

## Dependencies

| Dependency | Type | Notes |
|------------|------|-------|
| E1-S2 (ACMRecord Model) | Story | Query methods |
| Existing chat context | Code | source_chat.py |

---

*Tech-Spec generated by create-tech-spec workflow*
