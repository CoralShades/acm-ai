# Tech-Spec: E3-S3 ACM Citation Reference Type

**Created:** 2025-12-07
**Status:** Ready for Development
**Epic:** E3 - Cell Citations & PDF Viewer
**Story:** S3 - Implement ACM Citation Reference Type

---

## Overview

### Problem Statement

The chat system can reference sources and notes using `[source:id]` and `[note:id]` patterns. ACM-AI needs a similar pattern `[acm:record_id:field_name]` so AI responses can cite specific ACM data cells.

### Solution

Extend the citation parser in `source-references.tsx` to:
- Recognize `[acm:record_id:field]` pattern
- Convert to clickable link
- Open ACMCellViewer modal on click
- Gracefully handle invalid references

### Scope

**In Scope:**
- Add ACM_REFERENCE_PATTERN regex
- Create ACMCitationLink component
- Integrate with existing citation system

**Out of Scope:**
- Modifying AI prompt (E4-S3)
- Creating new citations

---

## Implementation Plan

### Tasks

- [ ] **Task 1: Analyze existing citation patterns**
  - Read `frontend/src/lib/utils/source-references.tsx`
  - Understand parseSourceReferences function

- [ ] **Task 2: Add ACM citation pattern**
  - Pattern: `\[acm:([^:\]]+):?([^\]]*)\]`
  - Match: `[acm:acm_record:abc123:product]`

- [ ] **Task 3: Create ACMCitationLink component**
  - Render as clickable badge/link
  - Fetch record on click
  - Open ACMCellViewer modal

- [ ] **Task 4: Integrate into parseSourceReferences**
  - Add ACM case to parser
  - Return appropriate component

### Acceptance Criteria

- [ ] **AC1**: Parser recognizes `[acm:record_id:field]` pattern
- [ ] **AC2**: Converts to clickable link in chat
- [ ] **AC3**: Click opens ACMCellViewer modal
- [ ] **AC4**: Gracefully handles invalid references

---

## Code Specification

### File: `frontend/src/lib/utils/source-references.tsx` (modifications)

```typescript
// Add to existing patterns
const ACM_REFERENCE_PATTERN = /\[acm:([^:\]]+):?([^\]]*)\]/g

// Add ACMCitationLink component
function ACMCitationLink({
  recordId,
  field,
  onOpen
}: {
  recordId: string
  field?: string
  onOpen: (recordId: string, field: string) => void
}) {
  const handleClick = () => {
    onOpen(recordId, field || 'product')
  }

  return (
    <button
      onClick={handleClick}
      className="inline-flex items-center gap-1 px-1.5 py-0.5 text-xs font-medium
                 bg-amber-100 text-amber-800 rounded hover:bg-amber-200
                 dark:bg-amber-900 dark:text-amber-200"
    >
      <FileSpreadsheet className="h-3 w-3" />
      ACM {field || 'record'}
    </button>
  )
}

// Add to parseSourceReferences function
export function parseSourceReferences(
  text: string,
  handlers: {
    onSourceClick?: (id: string) => void
    onNoteClick?: (id: string) => void
    onInsightClick?: (id: string) => void
    onACMClick?: (recordId: string, field: string) => void  // NEW
  }
): React.ReactNode[] {
  // ... existing code ...

  // Add ACM pattern matching
  const acmMatches = text.matchAll(ACM_REFERENCE_PATTERN)
  for (const match of acmMatches) {
    const [fullMatch, recordId, field] = match
    // Replace with ACMCitationLink component
  }
}
```

---

## Dependencies

| Dependency | Type | Notes |
|------------|------|-------|
| E3-S2 (PDF Viewer) | Story | Modal to open |
| Existing citation system | Code | source-references.tsx |

---

*Tech-Spec generated by create-tech-spec workflow*
